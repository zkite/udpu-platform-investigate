# Роли UDPU (api-service/app/domain/api/roles)

## 1. Назначение роли и общий контур

Роль UDPU — это конфигурационный объект, описывающий сетевые параметры и дополнительные флаги поведения для устройств UDPU (мDPU) и связанных сущностей. В коде роль используется как:

- справочник для валидации при создании/обновлении UDPU;
- источник интерфейсных параметров (GHN/LCMP) для VBUser;
- фильтр для привязки Job и JobQueue к конкретной группе устройств.

Роль хранится в Redis в виде hash под ключом `ROLE:<name>` и управляется через CRUD-эндпоинты `/roles`.

## 2. Хранение и сериализация

### 2.1. Ключи в Redis

- Ключ роли: `ROLE:<name>` (ROLE_PREFIX). Роль хранится как Redis hash, где `wireguard_tunnel`, `job_control`, `interfaces` сериализуются в JSON-строки.

### 2.2. Схема данных роли

Основной объект роли (UdpuRole / UdpuRoleUpdate):

- `name: str` — уникальный идентификатор роли (используется в ключе `ROLE:<name>`).
- `description: str` — человекочитаемое описание роли.
- `wireguard_tunnel: bool` — логический флаг, хранящийся в Redis как JSON-строка ("true"/"false").
- `job_control: bool` — логический флаг, хранящийся аналогично `wireguard_tunnel`.
- `interfaces: Interface` — вложенная структура интерфейсов.

Вложенные структуры:

- `Interface`:
  - `management_vlan: ManagementVlan` — описание management VLAN.
  - `ghn_ports: List[GhnPort]` — список GHN портов.
- `ManagementVlan`:
  - `interface: str` — название интерфейса (по умолчанию `br-lan`).
- `GhnPort`:
  - `ghn_interface: str` — GHN-интерфейс (по умолчанию `1/0`).
  - `lcmp_interface: str` — LCMP-интерфейс (по умолчанию `1/0.4098`).
  - `vb: bool` — флаг VB для порта.

### 2.3. Нормализация интерфейсов

Функция `_normalize_interfaces()` приводит `interfaces` к нормализованному виду:

- если `interfaces` пустые — возвращает `{ "management_vlan": {}, "ghn_ports": [] }`;
- если `ghn_ports` является словарём, то преобразует его в список (обрабатывает `port_1`, `port_2`, либо все значения словаря);
- если `ghn_ports` не является ни словарём, ни списком — заменяет на пустой список.

Эта нормализация применяется при чтении роли и при формировании данных для записи в Redis.

## 3. CRUD API и поведение

### 3.1. Создание роли (`POST /roles`)

- Проверяет наличие роли с таким именем.
- Создаёт запись `ROLE:<name>` с сериализацией полей.

### 3.2. Получение роли (`GET /roles/{name}`)

- Возвращает роль по ключу `ROLE:<name>`.
- JSON-поля (`wireguard_tunnel`, `job_control`, `interfaces`) десериализуются.
- `interfaces` дополнительно нормализуются.

### 3.3. Список ролей (`GET /roles`)

- Сканирует Redis по ключам `ROLE:*`.
- Для каждого ключа вызывает `get_udpu_role()` (включая нормализацию).

### 3.4. Обновление роли (`PATCH /roles/{name}`)

- Если роль не существует — 404.
- Выполняет полное обновление с переупаковкой всех полей роли.
- Если изменилось имя роли:
  - удаляет старый ключ `ROLE:<old_name>`;
  - создаёт новый ключ `ROLE:<new_name>`;
  - обновляет все UDPU записи (ключи `UDPU:*`) у которых `role == old_name`;
  - обновляет `role` в Jobs (`JOB:*`) и JobQueues (`QUEUE:*`).
- Если имя не менялось — просто обновляет hash в Redis.

### 3.5. Клонирование (`POST /roles/clone`)

- Копирует Redis hash `ROLE:<source>` в `ROLE:<new_role_name>`.
- В клон напрямую переносится сериализованное содержимое (без дополнительной нормализации).
- Поле `name` в Redis-данных подменяется на новое имя.

### 3.6. Удаление (`DELETE /roles/{name}`)

- Удаляет ключ `ROLE:<name>`.
- Ссылки в UDPU/Jobs/Queues не обновляются и остаются со старым именем (нет каскадного удаления).

## 4. Влияние роли на объекты и процессы

### 4.1. UDPU (Northbound)

- Роль обязательна при создании UDPU (`POST /udpu`) и при обновлениях (bulk и single update).
- Если роль не найдена — запрос отклоняется (`400`).
- При обновлении роли (rename) роль обновляется во всех UDPU записях, где совпадает старое имя.

### 4.2. VBUser

- Для VBUser роль не хранится напрямую, но вычисляются `ghn_interface` и `lcmp_interface` на основе роли UDPU.
- При создании UDPU эти интерфейсы используются для создания VBUser.
- При bulk-обновлении UDPU (изменение role) происходит обновление интерфейсов VBUser, если роль найдена.
- В `get_detailed_vbuser()` выполняется пересчёт интерфейсов на основании текущей роли UDPU.

### 4.3. Jobs

- `JobSchema.role` — строковое поле, используемое для фильтрации задач по роли (`GET /roles/{role_name}/jobs`).
- При переименовании роли поле `role` обновляется во всех Job-записях, где оно равно старому имени.

### 4.4. Job Queues

- `JobQueueSchema.role` — строковое поле, определяющее принадлежность очереди к роли.
- Очереди доступны через `GET /roles/{role_name}/queues`.
- При переименовании роли поле `role` обновляется во всех JobQueue-записях, где оно равно старому имени.

### 4.5. Frontend (UI)

- Роли отображаются и управляются в UI (создание, редактирование, клонирование, удаление).
- UI использует поля `name`, `description`, `wireguard_tunnel`, `job_control`, `interfaces.management_vlan.interface`, `interfaces.ghn_ports`.
- В разделе UDPU роль используется для выбора при создании/обновлении устройства, а также отображается в списках.

## 5. Разбор каждого поля роли и фактическая применимость

### 5.1. `name`

**Где используется:**
- часть Redis-ключа (`ROLE:<name>`);
- ссылка из UDPU (`udpu.role`);
- фильтр в Jobs/Queues (`role`), API-эндпоинты `/roles/{name}`, `/roles/{name}/jobs`, `/roles/{name}/queues`;
- отображение и навигация в UI.

**Эффект:**
- меняет ключ хранения и идентификацию роли во всех связанных сущностях.
- при переименовании выполняется каскадное обновление UDPU/Jobs/Queues.

### 5.2. `description`

**Где используется:**
- UI отображение (роль/список).
- Сохраняется в Redis и возвращается API.

**Эффект:**
- не влияет на бизнес-логику, используется только как описание.

### 5.3. `wireguard_tunnel`

**Где используется:**
- отображение в UI (карточка роли).
- хранится/возвращается API.

**Эффект:**
- в коде не используется в логике WireGuard или UDPU; это флаг-метаданные без поведенческого влияния.

### 5.4. `job_control`

**Где используется:**
- отображение в UI (карточка роли).
- хранится/возвращается API.

**Эффект:**
- в коде не используется для управления jobs/queues; сейчас это метаданные без эффекта на поведение.

### 5.5. `interfaces.management_vlan.interface`

**Где используется:**
- отображается в UI (роль/список/детали).
- хранится/возвращается API.

**Эффект:**
- напрямую не влияет на backend-логику; используется только как часть описания роли.

### 5.6. `interfaces.ghn_ports[*].ghn_interface` и `interfaces.ghn_ports[*].lcmp_interface`

**Где используется:**
- `get_primary_ghn_interfaces()` возвращает значения из первого элемента списка `ghn_ports`.
- Используются при создании VBUser и обновлении интерфейсов VBUser.

**Эффект:**
- напрямую влияют на значения `ghn_interface` и `lcmp_interface` у VBUser;
- при отсутствии портов возвращаются пустые строки.

### 5.7. `interfaces.ghn_ports[*].vb`

**Где используется:**
- отображается в UI (таблица GHN ports, индикатор VB).
- хранится/возвращается API.

**Эффект:**
- не используется в backend-логике; сейчас это метаданные без влияния.

## 6. Зависимости и каскады

### 6.1. Что зависит от роли

- UDPU записи (`UDPU:<subscriber_uid>`) содержат поле `role`.
- VBUser интерфейсы (`ghn_interface`, `lcmp_interface`) зависят от роли UDPU.
- Jobs и JobQueues ссылаются на роль для фильтрации.

### 6.2. Что обновляется при изменении роли

- При переименовании роли обновляются:
  - `udpu.role` у всех UDPU сущностей, где роль совпадает;
  - `role` у Jobs (JOB:*);
  - `role` у JobQueues (QUEUE:*).

### 6.3. Что НЕ обновляется при изменении роли

- При удалении роли не выполняются каскадные изменения или очистки ссылок в UDPU/Jobs/Queues.
- При обновлении полей роли, кроме имени, внешние объекты не обновляются (нет триггеров).

## 7. Дополнительные замечания и крайние случаи

- В `update_role()` обновление UDPU по роли выполняется только для ключей `UDPU:*`, где suffix соответствует regex `[a-f0-9]{16}` (16 hex символов). Если есть нестандартные UDPU ключи, они не будут обновлены.
- `clone_role()` не выполняет валидацию или нормализацию данных — копирует "как есть".
- Если у роли отсутствуют `interfaces.ghn_ports`, то VBUser получит пустые строки для интерфейсов.

## 8. Проверки и ограничения

- Тесты и проверки не запускались (задача носит аналитический характер).
