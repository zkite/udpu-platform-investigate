# Notes

## Изменения UI
- В деталях job добавлен запуск через WebSocket, чтобы из фронтенда отправлять команду `run job <name>` и получать ответ из `/api/v1.0/pub`. Для подключения требуется указать `channel` (идентификатор клиента/UDPU), совпадающий с используемым в текущем API. Реализация делает одноразовое подключение и ожидает один ответ, после чего закрывает сокет.

## Ограничения и допущения
- В UI отсутствует механизм обнаружения доступных `channel`; пользователь вводит его вручную, так как это значение хранится вне UI и задаётся внешними процессами.

## Скриншот
- Попытка сделать скриншот через Playwright не удалась: локальный Streamlit не запустился, страница вернула пустой ответ.

## Изменения интерфейса Jobs
- Для выбора канала запуска джобы используется выпадающий список subscriber_uid, который собирается из uDPU по всем локациям; если список недоступен/пуст, остаётся ручной ввод.
- Джоба `registered_device` скрыта из списка и принудительно не отображается в деталях (возврат к списку).
- Ответ выполнения джобы очищается при смене джобы и при выходе из просмотра деталей (а также при уходе с вкладки Jobs).

## Ограничения
- Источник списка каналов зависит от доступности `/udpu/locations` и `/{location}/udpu_list` в API; при ошибке списка используется ручной ввод.

## Исправление ошибки Redis NoneType при создании job
- Исключён вывод полей со значением None при сериализации JobSchema, чтобы Redis hset не получал None (ошибка Invalid input of type: 'NoneType').
- Контракт публичного API не менялся, сериализация влияет только на запись в Redis.
## 2025-09-29: Исправление выполнения job через UI

### Контекст и симптомы
- При запуске job из UI для job, созданных через frontend, в API сервисе фиксировалась ошибка `Publisher error`.
- При создании job через API (Postman) запуск из UI работал корректно.
- Требование: job должна исполняться при ручном запуске, без побочных действий.

### Наблюдения
- UI запускает job через WebSocket `/pub` и команду `run job <name>`.
- В обработчике `/pub` данные job отправляются в Redis Stream через `xadd`.
- Для job без заданной частоты `frequency` в Redis передавалось `None`, что приводит к исключению в `redis.xadd` (Redis не принимает `None`).
- В frontend форма создания job допускает пустую частоту, в итоге job сохраняется с `frequency = None`.

### Решение
- При публикации job в Redis Stream заменять пустую частоту на `"once"`.
- Это соответствует логике ручного запуска: job исполняется один раз, даже если частота не задана.

### Затронутые файлы
- `api-service/app/domain/api/websocket/view.py`

### Проверки
- Локальные тесты не запускались (не было запроса и контекста для запуска).


## 2025-10-02: Повторное создание job при запуске

### Контекст и симптомы
- При запуске job она появлялась в списке повторно.
- Дубликат имел частично пустые поля, совпадая по `name`.

### Наблюдения
- Список job формируется из Redis по шаблону `JOB:*`.
- Ключи логов job имеют префикс `JOB:LOGS:...` и также попадают под шаблон `JOB:*`.
- При парсинге логов как `JobSchema` возникали «псевдо‑job» записи, что визуально выглядело как повторное создание.

### Решение
- Отфильтровывать ключи хранения job по формату `JOB:<name>:<uid>` (ровно 3 сегмента), исключая `JOB:LOGS:*` и прочие нерелевантные ключи.

### Затронутые файлы
- `api-service/app/domain/api/jobs/core.py`

### Проверки
- Локальные тесты не запускались (не было запроса).
